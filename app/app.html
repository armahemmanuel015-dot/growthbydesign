<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowthByDesign | App</title>
    <style>
        :root {
            --bg: #05070a;
            --glass: rgba(255, 255, 255, 0.05);
            --accent: #00f2ff;
            --success: #00ff88;
            --danger: #ff4b2b;
        }

        body { margin: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; }
        
        /* Navigation */
        nav { display: flex; justify-content: center; background: rgba(0,0,0,0.4); padding: 15px; position: sticky; top: 0; backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass); z-index: 100; }
        nav button { background: none; border: none; color: white; margin: 0 15px; cursor: pointer; opacity: 0.6; font-weight: 600; }
        nav button.active { opacity: 1; color: var(--accent); border-bottom: 2px solid var(--accent); }

        .container { max-width: 700px; margin: 20px auto; padding: 20px; }
        .view { display: none; }
        .active { display: block; }

        /* Cards & UI */
        .card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { background: rgba(255,255,255,0.1); border: 1px solid var(--glass); padding: 12px; color: white; border-radius: 8px; flex: 1; outline: none; }
        
        .task-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; background: rgba(255,255,255,0.03); margin: 10px 0; 
            border-radius: 12px; border-left: 4px solid var(--accent);
        }

        /* Custom Checkbox */
        .checkbox-container { display: flex; align-items: center; gap: 15px; font-size: 1.1rem; cursor: pointer; }
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; accent-color: var(--success); }

        .delete-btn { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; font-weight: bold; opacity: 0.5; }
        .delete-btn:hover { opacity: 1; }

        .leader-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--glass); }
        .time-tag { color: var(--accent); font-weight: bold; }
        .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: var(--success); color: #000; }
    </style>
</head>
<body>

    <nav id="main-nav">
        <button onclick="showView('tasks-view')" id="nav-tasks" class="active">Daily Tasks</button>
        <button onclick="showView('leader-view')" id="nav-leader">Leaderboard</button>
        <button onclick="showView('analytics-view')" id="nav-analytics">Analytics</button>
        <button onclick="logout()" style="color: var(--danger);">Logout</button>
    </nav>

    <div class="container">
        <section id="tasks-view" class="view active">
            <div class="card">
                <h2>Shared Goals</h2>
                <div class="input-group">
                    <input type="text" id="newTask" placeholder="Add a shared daily task...">
                    <button onclick="addSharedTask()" style="background: var(--accent); border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">Add</button>
                </div>
                <div id="taskList"></div>
            </div>
        </section>

        <section id="leader-view" class="view">
            <div class="card">
                <h2>Today's Velocity</h2>
                <p style="font-size: 0.8rem; color: #888;">Ranked by earliest completion</p>
                <div id="leaderList"></div>
            </div>
        </section>

        <section id="analytics-view" class="view">
            <div class="card">
                <h2>Who Succeeded Yesterday?</h2>
                <div id="analyticsContent"></div>
            </div>
        </section>
    </div>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

const firebaseConfig = { /* YOUR CONFIG */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
const todayKey = new Date().toISOString().split('T')[0];

onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = 'index.html';
    } else {
        currentUser = user;
        // CREATE USER IN DB IF NOT EXISTS
        await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email
        }, { merge: true });
        
        initApp();
    }
});

// --- CORE LOGIC ---

async function initApp() {
    // 1. Get current user's completions for today to set checkbox states
    const myCompletionsQuery = query(
        collection(db, "completions"), 
        where("userId", "==", currentUser.uid),
        where("dateKey", "==", todayKey)
    );
    const myCompletionsSnap = await getDocs(myCompletionsQuery);
    const finishedTaskIds = new Set();
    myCompletionsSnap.forEach(doc => finishedTaskIds.add(doc.data().taskId));

    // 2. Load Shared Tasks and Apply Checkbox state
    onSnapshot(collection(db, "sharedTasks"), (snap) => {
        const list = document.getElementById('taskList');
        list.innerHTML = "";
        snap.forEach(tDoc => {
            const task = tDoc.data();
            const isChecked = finishedTaskIds.has(tDoc.id) ? "checked disabled" : "";
            list.innerHTML += `
                <div class="task-item">
                    <label class="checkbox-container">
                        <input type="checkbox" ${isChecked} onchange="tickTask('${tDoc.id}', '${task.name}')">
                        ${task.name}
                    </label>
                    <button class="delete-btn" onclick="deleteTask('${tDoc.id}')">×</button>
                </div>`;
        });
    });

    // 3. Leaderboard Listener
    const qLeader = query(collection(db, "completions"), where("dateKey", "==", todayKey), orderBy("timestamp", "asc"));
    onSnapshot(qLeader, (snap) => {
        const list = document.getElementById('leaderList');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            list.innerHTML += `<div class="leader-row">
                <span><b>${d.userName}</b>: ${d.taskName}</span>
                <span class="time-tag">${new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
            </div>`;
        });
    });
}

window.tickTask = async (taskId, taskName) => {
    const now = new Date();
    // 11:50 PM DEADLINE CHECK
    if (now.getHours() === 23 && now.getMinutes() >= 50) {
        alert("Window closed at 11:50 PM!");
        location.reload(); // Reset checkbox
        return;
    }

    await addDoc(collection(db, "completions"), {
        taskId,
        taskName,
        userId: currentUser.uid,
        userName: currentUser.displayName,
        timestamp: Date.now(),
        dateKey: todayKey
    });
    alert("Task recorded!");
    location.reload(); // Refresh to lock the checkbox
};import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

const firebaseConfig = { /* YOUR CONFIG */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
const todayKey = new Date().toISOString().split('T')[0];

onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = 'index.html';
    } else {
        currentUser = user;
        // CREATE USER IN DB IF NOT EXISTS
        await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email
        }, { merge: true });
        
        initApp();
    }
});

// --- CORE LOGIC ---

async function initApp() {
    // 1. Get current user's completions for today to set checkbox states
    const myCompletionsQuery = query(
        collection(db, "completions"), 
        where("userId", "==", currentUser.uid),
        where("dateKey", "==", todayKey)
    );
    const myCompletionsSnap = await getDocs(myCompletionsQuery);
    const finishedTaskIds = new Set();
    myCompletionsSnap.forEach(doc => finishedTaskIds.add(doc.data().taskId));

    // 2. Load Shared Tasks and Apply Checkbox state
    onSnapshot(collection(db, "sharedTasks"), (snap) => {
        const list = document.getElementById('taskList');
        list.innerHTML = "";
        snap.forEach(tDoc => {
            const task = tDoc.data();
            const isChecked = finishedTaskIds.has(tDoc.id) ? "checked disabled" : "";
            list.innerHTML += `
                <div class="task-item">
                    <label class="checkbox-container">
                        <input type="checkbox" ${isChecked} onchange="tickTask('${tDoc.id}', '${task.name}')">
                        ${task.name}
                    </label>
                    <button class="delete-btn" onclick="deleteTask('${tDoc.id}')">×</button>
                </div>`;
        });
    });

    // 3. Leaderboard Listener
    const qLeader = query(collection(db, "completions"), where("dateKey", "==", todayKey), orderBy("timestamp", "asc"));
    onSnapshot(qLeader, (snap) => {
        const list = document.getElementById('leaderList');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            list.innerHTML += `<div class="leader-row">
                <span><b>${d.userName}</b>: ${d.taskName}</span>
                <span class="time-tag">${new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
            </div>`;
        });
    });
}

window.tickTask = async (taskId, taskName) => {
    const now = new Date();
    // 11:50 PM DEADLINE CHECK
    if (now.getHours() === 23 && now.getMinutes() >= 50) {
        alert("Window closed at 11:50 PM!");
        location.reload(); // Reset checkbox
        return;
    }

    await addDoc(collection(db, "completions"), {
        taskId,
        taskName,
        userId: currentUser.uid,
        userName: currentUser.displayName,
        timestamp: Date.now(),
        dateKey: todayKey
    });
    alert("Task recorded!");
    location.reload(); // Refresh to lock the checkbox
};
    </script>
</body>
</html>
