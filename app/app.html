<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowthByDesign | Elite Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg: #05070a;
            --surface: rgba(22, 26, 34, 0.7);
            --surface-hover: rgba(28, 33, 44, 0.9);
            --accent: #00f2ff; 
            --success: #10b981;
            --danger: #ef4444;
            --text-main: #f3f4f6;
            --text-dim: #9ca3af;
            --glass-border: rgba(255, 255, 255, 0.08);
            --gold: linear-gradient(135deg, #fde68a 0%, #d97706 100%);
            --cyber-glow: 0 0 20px rgba(0, 242, 255, 0.15);
        }

        body { 
            margin: 0; background: var(--bg); color: var(--text-main); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.02) 1px, transparent 1px),
                radial-gradient(circle at 50% -20%, #11141d 0%, #05070a 100%);
            background-size: 50px 50px, 50px 50px, 100% 100%;
            min-height: 100vh; overflow-x: hidden;
        }
        
        nav { 
            display: flex; justify-content: space-between; align-items: center; padding: 15px 40px; 
            position: sticky; top: 0; backdrop-filter: blur(20px); 
            background: rgba(5, 7, 10, 0.8); border-bottom: 1px solid var(--glass-border); z-index: 100; 
        }

        .nav-links { display: flex; gap: 8px; }

        nav button { 
            background: none; border: none; color: var(--text-dim); 
            padding: 10px 18px; cursor: pointer; font-weight: 700; 
            font-size: 0.75rem; letter-spacing: 1px; transition: 0.3s; border-radius: 12px;
        }
        nav button.active { color: var(--accent); background: rgba(0, 242, 255, 0.05); box-shadow: var(--cyber-glow); }
        nav button:hover:not(.active) { color: var(--accent); }

        .container { max-width: 800px; margin: 40px auto; padding: 0 20px; }
        .view { display: none; animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .view.active { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--surface); border: 1px solid var(--glass-border); 
            border-radius: 24px; padding: 28px; margin-bottom: 24px;
            backdrop-filter: blur(10px); transition: 0.3s;
        }
        .card:hover { border-color: rgba(0, 242, 255, 0.3); }

        /* Directives */
        .task-item {
            background: rgba(255,255,255,0.02); padding: 18px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; border: 1px solid var(--glass-border); transition: 0.3s;
        }
        .task-item:hover { background: rgba(255,255,255,0.04); }

        .check-btn {
            width: 28px; height: 28px; border-radius: 8px; border: 2px solid var(--glass-border);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.3s; font-weight: 800;
        }
        .check-btn.done { background: var(--success); border-color: var(--success); color: white; }

        /* Intelligence & Collapsibles */
        .collapse-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        
        .collapse-content { 
            max-height: 0; opacity: 0; overflow: hidden; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .collapse-content.open { 
            max-height: 1000px; opacity: 1; padding-top: 20px; margin-top: 15px; 
            border-top: 1px solid var(--glass-border); 
        }

        .toggle-icon { font-size: 1.2rem; color: var(--accent); transition: 0.3s; }
        .card:has(.open) .toggle-icon { transform: rotate(45deg); color: var(--danger); }

        .mini-heatmap { display: flex; gap: 6px; margin-top: 10px; }
        .day-box { flex: 1; height: 10px; border-radius: 3px; background: rgba(255,255,255,0.05); }
        .day-box.active { background: var(--accent); box-shadow: 0 0 10px rgba(0, 242, 255, 0.4); }

        /* Leaderboard */
        .rank-row { 
            display: flex; align-items: center; padding: 16px; 
            background: rgba(255,255,255,0.03); border-radius: 20px; margin-bottom: 12px;
        }
        .rank-medal { 
            width: 40px; height: 40px; border-radius: 12px; display: flex; 
            align-items: center; justify-content: center; font-weight: 800; margin-right: 20px; 
        }
        .rank-1 { background: var(--gold); color: #000; }

        /* Inputs & Buttons */
        .input-group { 
            display: flex; gap: 12px; background: rgba(0,0,0,0.3); padding: 10px; 
            border-radius: 18px; border: 1px solid var(--glass-border); margin-bottom: 32px; 
        }
        input[type="text"] { background: none; border: none; padding: 12px; color: white; flex: 1; outline: none; font-family: inherit; }
        
        .btn-primary { 
            background: var(--accent); color: #000; border: none; padding: 12px 24px; 
            border-radius: 14px; font-weight: 800; cursor: pointer; transition: 0.3s;
        }
        .btn-primary:hover { background: white; transform: translateY(-2px); }

        #victoryOverlay {
            position: fixed; inset: 0; background: rgba(5,7,10,0.95); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(15px);
        }
    </style>
</head>
<body>

    <div id="victoryOverlay">
        <h1 style="font-size: 3rem; font-weight: 900; background: var(--gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SUNDAY VICTORY</h1>
        <div id="winnerList" style="margin: 30px 0;"></div>
        <button class="btn-primary" onclick="closeVictory()">Enter Dashboard</button>
    </div>

    <nav>
        <div style="font-weight: 800; font-size: 1.2rem; color: var(--accent); letter-spacing: -1px;">GBD</div>
        <div class="nav-links">
            <button onclick="showView('tasks-view')" id="nav-tasks" class="active">DIRECTIVES</button>
            <button onclick="showView('leader-view')" id="nav-leader">LEADERBOARD</button>
            <button onclick="showView('analytics-view')" id="nav-analytics">INTELLIGENCE</button>
        </div>
        <button onclick="logout()" style="color: var(--danger); font-weight: 800;">EXIT</button>
    </nav>

    <div class="container">
        <section id="tasks-view" class="view active">
            <h2 style="font-weight: 800; font-size: 2rem; letter-spacing: -1px;">Active Objectives</h2>
            <div class="input-group">
                <input type="text" id="newTask" placeholder="Define new team target...">
                <button onclick="addSharedTask()" class="btn-primary">Deploy</button>
            </div>
            <div id="taskList"></div>
        </section>

        <section id="leader-view" class="view">
            <h2 style="font-weight: 800; font-size: 2rem; letter-spacing: -1px;">Elite Standings</h2>
            <div id="leaderboardContent"></div>
        </section>

        <section id="analytics-view" class="view">
            <h2 style="font-weight: 800; font-size: 2rem; letter-spacing: -1px;">Intelligence</h2>
            <p style="color: var(--text-dim); margin-top: -15px; margin-bottom: 30px; font-size: 0.85rem;">Historical performance over the last 7 cycles.</p>
            <div id="intelligenceContent"></div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCu03ePMFx9mDgbCdT9LWcoPOg2SGQIBEU",
            authDomain: "growthbydesign-2a6d0.firebaseapp.com",
            projectId: "growthbydesign-2a6d0",
            storageBucket: "growthbydesign-2a6d0.firebasestorage.app",
            messagingSenderId: "807311473882",
            appId: "1:807311473882:web:49300d2d84355eb4cbb9e3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        const todayKey = new Date().toISOString().split('T')[0];

        onAuthStateChanged(auth, async (user) => {
            if (!user) window.location.href = 'index.html'; 
            else { 
                currentUser = user; 
                await setDoc(doc(db, "users", user.uid), { uid: user.uid, email: user.email }, { merge: true });
                initApp(); 
            }
        });

        window.logout = () => signOut(auth);
        
        window.showView = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            const navId = 'nav-' + id.split('-')[0];
            if(document.getElementById(navId)) document.getElementById(navId).classList.add('active');
            if(id === 'analytics-view' || id === 'leader-view') refreshAll();
        };

        window.toggleCollapse = (id) => {
            document.getElementById(id).classList.toggle('open');
        };

        window.addSharedTask = async () => {
            const name = document.getElementById('newTask').value;
            if(!name) return;
            await addDoc(collection(db, "sharedTasks"), { name, createdAt: Date.now() });
            document.getElementById('newTask').value = "";
        };

        window.tickTask = async (taskId, taskName) => {
            await addDoc(collection(db, "completions"), {
                taskId, taskName, userId: currentUser.uid, 
                userName: currentUser.displayName || currentUser.email.split('@')[0],
                timestamp: Date.now(), dateKey: todayKey
            });
            refreshAll();
        };

        window.closeVictory = () => { document.getElementById('victoryOverlay').style.display = 'none'; };

        async function initApp() {
            onSnapshot(query(collection(db, "sharedTasks"), orderBy("createdAt", "asc")), async (snap) => {
                const compsSnap = await getDocs(query(collection(db, "completions"), where("userId", "==", currentUser.uid), where("dateKey", "==", todayKey)));
                const finishedIds = new Set();
                compsSnap.forEach(d => finishedIds.add(d.data().taskId));

                const list = document.getElementById('taskList');
                list.innerHTML = "";
                snap.forEach(tDoc => {
                    const task = tDoc.data();
                    const isDone = finishedIds.has(tDoc.id);
                    list.innerHTML += `
                    <div class="task-item">
                        <span style="${isDone ? 'text-decoration:line-through; color:var(--text-dim)' : 'font-weight:600'}">${task.name}</span>
                        <div onclick="${isDone ? '' : `tickTask('${tDoc.id}', '${task.name}')`}" 
                             class="check-btn ${isDone ? 'done' : ''}">
                            ${isDone ? '✓' : ''}
                        </div>
                    </div>`;
                });
            });
            checkSundayCelebration();
        }

        async function refreshAll() {
            const tasksSnap = await getDocs(collection(db, "sharedTasks"));
            const compsSnap = await getDocs(collection(db, "completions"));
            const allTasks = [];
            tasksSnap.forEach(t => allTasks.push({id: t.id, name: t.data().name}));

            const activity = {};
            compsSnap.forEach(doc => {
                const d = doc.data();
                if (!activity[d.userId]) activity[d.userId] = { name: d.userName, taskDates: {}, totalAllTime: 0 };
                if (!activity[d.userId].taskDates[d.taskId]) activity[d.userId].taskDates[d.taskId] = new Set();
                activity[d.userId].taskDates[d.taskId].add(d.dateKey);
                activity[d.userId].totalAllTime++;
            });

            renderLeaderboard(activity);
            renderIntelligence(activity, allTasks);
        }

        function renderLeaderboard(activity) {
            const container = document.getElementById('leaderboardContent');
            const sorted = Object.entries(activity).sort((a,b) => b[1].totalAllTime - a[1].totalAllTime);
            container.innerHTML = sorted.map(([uid, data], i) => `
                <div class="rank-row">
                    <div class="rank-medal ${i === 0 ? 'rank-1' : ''}">${i + 1}</div>
                    <div style="flex:1">
                        <div style="font-weight:800;">${data.name}</div>
                        <div style="font-size:0.7rem; color:var(--text-dim)">Total Tasks Cleared</div>
                    </div>
                    <div style="font-size:1.4rem; font-weight:900; color:var(--accent)">${data.totalAllTime}</div>
                </div>`).join('');
        }

        function renderIntelligence(activity, allTasks) {
            const container = document.getElementById('intelligenceContent');
            const last7 = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                last7.push(d.toISOString().split('T')[0]);
            }

            container.innerHTML = Object.entries(activity).map(([uid, data]) => {
                const taskHtml = allTasks.map(task => {
                    const dates = data.taskDates[task.id] || new Set();
                    const boxes = last7.map(day => `<div class="day-box ${dates.has(day) ? 'active' : ''}"></div>`).join('');
                    return `<div style="margin-bottom:15px;">
                                <div style="font-size:0.75rem; font-weight:700; margin-bottom:5px;">${task.name}</div>
                                <div class="mini-heatmap">${boxes}</div>
                            </div>`;
                }).join('');

                return `<div class="card">
                    <div class="collapse-header" onclick="toggleCollapse('col-${uid}')">
                        <div>
                            <div style="font-weight:900; font-size:1.1rem; color:var(--accent);">${data.name}</div>
                            <div style="font-size:0.7rem; color:var(--text-dim)">View consistency map</div>
                        </div>
                        <div class="toggle-icon">+</div>
                    </div>
                    <div class="collapse-content" id="col-${uid}">${taskHtml}</div>
                </div>`;
            }).join('');
        }

        async function checkSundayCelebration() {
            if(new Date().getDay() === 0) {
                const compsSnap = await getDocs(collection(db, "completions"));
                const counts = {};
                compsSnap.forEach(d => {
                    const data = d.data();
                    counts[data.userId] = (counts[data.userId] || {name: data.userName, c: 0});
                    counts[data.userId].c++;
                });
                const sorted = Object.values(counts).sort((a,b) => b.c - a.c).slice(0, 3);
                if(sorted.length > 0) {
                    document.getElementById('victoryOverlay').style.display = 'flex';
                    document.getElementById('winnerList').innerHTML = sorted.map(u => `<h2 style="margin:10px">${u.name} — ${u.c}</h2>`).join('');
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }
            }
        }
    </script>
</body>
</html>
