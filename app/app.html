<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowthByDesign | App</title>
    <style>
        :root {
            --bg: #05070a;
            --glass: rgba(255, 255, 255, 0.05);
            --accent: #00f2ff;
            --success: #00ff88;
            --danger: #ff4b2b;
        }

        body { margin: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; }
        
        /* Navigation */
        nav { display: flex; justify-content: center; background: rgba(0,0,0,0.4); padding: 15px; position: sticky; top: 0; backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass); z-index: 100; }
        nav button { background: none; border: none; color: white; margin: 0 15px; cursor: pointer; opacity: 0.6; font-weight: 600; }
        nav button.active { opacity: 1; color: var(--accent); border-bottom: 2px solid var(--accent); }

        .container { max-width: 700px; margin: 20px auto; padding: 20px; }
        .view { display: none; }
        .active { display: block; }

        /* Cards & UI */
        .card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { background: rgba(255,255,255,0.1); border: 1px solid var(--glass); padding: 12px; color: white; border-radius: 8px; flex: 1; outline: none; }
        
        .task-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; background: rgba(255,255,255,0.03); margin: 10px 0; 
            border-radius: 12px; border-left: 4px solid var(--accent);
        }

        /* Custom Checkbox */
        .checkbox-container { display: flex; align-items: center; gap: 15px; font-size: 1.1rem; cursor: pointer; }
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; accent-color: var(--success); }

        .delete-btn { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; font-weight: bold; opacity: 0.5; }
        .delete-btn:hover { opacity: 1; }

        .leader-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--glass); }
        .time-tag { color: var(--accent); font-weight: bold; }
        .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: var(--success); color: #000; }
    </style>
</head>
<body>

    <nav id="main-nav">
        <button onclick="showView('tasks-view')" id="nav-tasks" class="active">Daily Tasks</button>
        <button onclick="showView('leader-view')" id="nav-leader">Leaderboard</button>
        <button onclick="showView('analytics-view')" id="nav-analytics">Analytics</button>
        <button onclick="logout()" style="color: var(--danger);">Logout</button>
    </nav>

    <div class="container">
        <section id="tasks-view" class="view active">
            <div class="card">
                <h2>Shared Goals</h2>
                <div class="input-group">
                    <input type="text" id="newTask" placeholder="Add a shared daily task...">
                    <button onclick="addSharedTask()" style="background: var(--accent); border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">Add</button>
                </div>
                <div id="taskList"></div>
            </div>
        </section>

        <section id="leader-view" class="view">
            <div class="card">
                <h2>Today's Velocity</h2>
                <p style="font-size: 0.8rem; color: #888;">Ranked by earliest completion</p>
                <div id="leaderList"></div>
            </div>
        </section>

        <section id="analytics-view" class="view">
            <div class="card">
                <h2>Who Succeeded Yesterday?</h2>
                <div id="analyticsContent"></div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCu03ePMFx9mDgbCdT9LWcoPOg2SGQIBEU",
            authDomain: "growthbydesign-2a6d0.firebaseapp.com",
            projectId: "growthbydesign-2a6d0",
            storageBucket: "growthbydesign-2a6d0.firebasestorage.app",
            messagingSenderId: "807311473882",
            appId: "1:807311473882:web:49300d2d84355eb4cbb9e3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;

        // --- AUTH CHECK ---
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                currentUser = user;
                initApp();
            }
        });

        window.logout = () => signOut(auth);

        // --- NAVIGATION ---
        window.showView = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + id.split('-')[0]).classList.add('active');
            if(id === 'analytics-view') runAnalytics();
        };

        // --- TASK LOGIC ---
        window.addSharedTask = async () => {
            const name = document.getElementById('newTask').value;
            if(!name) return;
            await addDoc(collection(db, "sharedTasks"), { 
                name, 
                createdAt: Date.now() 
            });
            document.getElementById('newTask').value = "";
        };

        window.deleteTask = async (id) => {
            if(confirm("Delete this task for everyone?")) {
                await deleteDoc(doc(db, "sharedTasks", id));
            }
        };

        window.toggleTick = async (taskId, taskName, isChecked) => {
            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];

            // 11:50 PM DEADLINE
            if (now.getHours() === 23 && now.getMinutes() >= 50) {
                alert("Deadline Reached (11:50 PM). Task cannot be logged.");
                return;
            }

            if (isChecked) {
                await addDoc(collection(db, "completions"), {
                    taskId,
                    taskName,
                    userName: currentUser.displayName,
                    userId: currentUser.uid,
                    timestamp: Date.now(),
                    dateKey: dateKey
                });
            }
            // Note: In this simple version, unchecking won't delete the record to prevent velocity manipulation.
        };

        function initApp() {
            // Load Shared Tasks
            onSnapshot(query(collection(db, "sharedTasks"), orderBy("createdAt", "asc")), (snap) => {
                const list = document.getElementById('taskList');
                list.innerHTML = "";
                snap.forEach(tDoc => {
                    const task = tDoc.data();
                    list.innerHTML += `
                        <div class="task-item">
                            <label class="checkbox-container">
                                <input type="checkbox" onchange="toggleTick('${tDoc.id}', '${task.name}', this.checked)">
                                ${task.name}
                            </label>
                            <button class="delete-btn" onclick="deleteTask('${tDoc.id}')">Ã—</button>
                        </div>`;
                });
            });

            // Load Leaderboard
            const today = new Date().toISOString().split('T')[0];
            const q = query(collection(db, "completions"), where("dateKey", "==", today), orderBy("timestamp", "asc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('leaderList');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const data = doc.data();
                    const time = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    list.innerHTML += `
                        <div class="leader-row">
                            <span><b>${data.userName}</b> done with <i>${data.taskName}</i></span>
                            <span class="time-tag">${time}</span>
                        </div>`;
                });
            });
        }

        // --- ANALYTICS ---
        async function runAnalytics() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];

            const q = query(collection(db, "completions"), where("dateKey", "==", dateStr));
            const snap = await getDocs(q);
            
            const results = {};
            snap.forEach(doc => {
                const d = doc.data();
                if(!results[d.userName]) results[d.userName] = 0;
                results[d.userName]++;
            });

            const content = document.getElementById('analyticsContent');
            content.innerHTML = `<h3>Stats for ${dateStr}</h3>`;
            Object.keys(results).length > 0 ? 
                Object.entries(results).forEach(([name, count]) => {
                    content.innerHTML += `<div class="leader-row"><span>${name}</span> <span class="status-badge">${count} Tasks Done</span></div>`;
                }) : 
                content.innerHTML = "<p>No activity recorded yesterday.</p>";
        }
    </script>
</body>
</html>
